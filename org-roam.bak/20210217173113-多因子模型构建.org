#+title: å¤šå› å­æ¨¡å‹æ„å»º
* å¤šå› å­æ¨¡å‹ç›¸å…³è®ºæ–‡
[[https://pic3.zhimg.com/80/v2-037c317a5bc6c4d30140b548e0451bd2_720w.jpg]]
* å¤šå› å­æ¨¡å‹æ„å»ºæµç¨‹
[[file:../pic/2021-02-17_17-31-33_screenshot.png]]
** åŸºç¡€æ•°æ®é‡‡é›†
*** å› å­çš„é€‰å–
[[https://cdn.bigquant.com/community/uploads/default/original/3X/0/a/0aa93e8185a432a535fa3327c1c26cee8e835c61.png]]
[[https://cdn.bigquant.com/community/uploads/default/original/3X/f/a/fa0ee4de1ab5a4ac2073e13af0ce936d4b416db8.png]]
[[https://cdn.bigquant.com/community/uploads/default/original/3X/8/c/8c7f47696b4e0004ba8e65feb1559ecda39f92f5.png]]
[[https://cdn.bigquant.com/community/uploads/default/original/3X/6/a/6a65eb2af39d0a180acaadea6b11daa55afab537.png]]
| å¤§ç±»å› å­       | å…·ä½“å› å­                     |
|----------------+------------------------------|
| ä¼°å€¼å› å­       | EP                           |
|                | EPcut                        |
|                | BP                           |
|                | OCFP                         |
|----------------+------------------------------|
| æˆé•¿           | sales_growth_ttm             |
|                | profit_growth_ttm            |
|                | operationcashflow_growth_ttm |
|----------------+------------------------------|
| è´¢åŠ¡è´¨é‡å› å­   | roe_ttm                      |
|                | roa_ttm                      |
|                | grossprofitmargin_ttm        |
|                | profitmargin_ttm             |
|                | assetturnover_ttm            |
|                | operationcashflowratio_ttm   |
|----------------+------------------------------|
| æ æ†å› å­       | financial_leverage           |
|                | debtequityratio              |
|                | cashration                   |
|                | currentratio                 |
|----------------+------------------------------|
| è§„æ¨¡å› å­       | ln_capital                   |
|----------------+------------------------------|
| åŠ¨é‡å› å­       | HAlpha                       |
|                | relative_strength_1m         |
|                | relative_strength_2m         |
|                | relative_strenth_3m          |
|----------------+------------------------------|
| æ³¢åŠ¨ç‡å› å­     | high_low_1m                  |
|                | high_low_2m                  |
|                | high_low_3m                  |
|                | std_1m                       |
|                | std_2m                       |
|                | std_3m                       |
|                | std_6m                       |
|----------------+------------------------------|
| åˆ†æå¸ˆæƒ…ç»ªå› å­ | rating_average               |
|                | rating_targetprice           |
|----------------+------------------------------|
| è‚¡ä¸œå› å­       | holder_avgpct                |
|                | holder_avgpctchange          |
|----------------+------------------------------|
| æŠ€æœ¯å› å­       | macd                         |
|                | dif                          |
|                | dea                          |
|----------------+------------------------------|
| è½¬å€ºå› å­       | cpr                          |
|                | ndr                          |

*** å°†å› å­æ–‡ä»¶æ•´åˆåˆ°æ€»è¡¨
#+begin_src python
def ombination_factors(code_tag):
    for factor in factors:
        indicator = pd.read_excel('./Wind/'+factor+'.xlsx')
        s =[]
        for cd in code:
            try:
                year = indicator['Date'].values
                factors = indicator[cd].values
                dict_factor = dict(zip(year,factors))
                jy.loc[jy[code_tag]==cd,factor]=jy.loc[jy[code_tag]==cd,'Trdmnt'].map(dict_factor)
            except:
                s.append(cd)
        print(len(s))
#+end_src
** æ•°æ®æ ‡å‡†åŒ–
#+begin_src python
# è°ƒç”¨çš„åŒ…
from atrader import *
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import math
import statsmodels.api as sm
import datetime as dt
import scipy.stats as stats
import seaborn as sns
#+end_src
*** å»æå€¼
**** MAD(Median Absolute Deviation, ç»å¯¹å€¼å·®ä¸­ä½æ•°æ³•)
#+begin_src python
def mad(series,n):
    median = series.quantile(0.5)
    diff_median = ((series - median).abs()).quantile(0.5)
    max_range = median + n * diff_median
    min_range = median - n * diff_median
    return np.clip(series, min_range, max_range)
#+end_src
**** $3\sigma$æ³•
#+begin_src python
def three_sigma(series,n):
    mean = series.mean()
    std = series.std()
    max_range = mean + n * std
    min_range = mean - n * std
    return np.clip(series, min_range, max_range)
#+end_src
**** ç™¾åˆ†ä½æ³•
#+begin_src python
def percentile(series, min= 0.025, max= 0.975):
    series = series.sort_values()
    q = series.quantile([min, max])
    return np.clip(series, q.iloc[0], q.iloc[-1])
#+end_src
*** ç¼ºå¤±å€¼å¤„ç†
å¤„ç†ä¸ºè¡Œä¸š(ç”³é“¶ä¸‡å›½)å¹³å‡å€¼
#+begin_src python
jy.fillna()
#+end_src
*** æ ‡å‡†åŒ–
**** Z-score æ ‡å‡†åŒ–
#+begin_src python
def standard_z_score(series):
    std = series.std()
    mean = series.mean()
    return (series-mean)/std
#+end_src
*** ä¸­æ€§åŒ–(ä¸­å’Œè¡Œä¸šå’Œå¸‚å€¼å› å­)
*ç”³é“¶ä¸‡å›½åˆ†ç±»* æ¯”è¾ƒé€‚åˆæŠ•èµ„ä½¿ç”¨
[[https://pic2.zhimg.com/80/v2-e7dee6788b0d76c5c99a755837286fb9_720w.jpg]]
#+begin_src python
if_neutral_industry = True
if_neutral_mktcap = True
    # æ˜¯å¦è¡Œä¸šä¸­æ€§
if if_neutral_industry:
    indname = industry.unique()      # è·å–è¡Œä¸šå
    class_var = pd.get_dummies(industry,columns=['industry'],prefix=['industry'],
                               prefix_sep="_", dummy_na=False, drop_first=False)
    class_var[indname[-1]] = 0

# æ˜¯å¦å¸‚å€¼ä¸­æ€§
if if_neutral_mktcap:

    # æå–æ€»å¸‚å€¼

    class_var['logmktcap'] = dfs['ln_cap']

data = pd.concat([data,class_var], axis=1)
if if_neutral_industry | if_neutral_mktcap:
    for j in data.columns:
        x = np.hstack((np.ones((len(data),1)),class_var.values))
        y = data.loc[:,j].values
        model = sml.OLS(y,x)
        result=model.fit()
        data.loc[:,j] = y -result.fittedvalues
#+end_src
** æœ‰æ•ˆå› å­è¯†åˆ«
*** Fama_Macbeth æ£€éªŒ
[[https://bashtage.github.io/linearmodels/panel/panel/linearmodels.panel.model.FamaMacBeth.html#linearmodels.panel.model.FamaMacBeth][Linearmodelsé‡Œçš„Fama_Macbeth æ–¹æ³•]]
*** ç•Œé¢å›å½’æ³•
[[https://cdn.bigquant.com/community/uploads/default/original/3X/2/e/2ef70b9d589e499a17e6504f7c11ea2248c92b3d.png]]
1. t å€¼ç»å¯¹å€¼åºåˆ—çš„å‡å€¼ï¼šå¯¹äºæ¯ä¸€æœŸçš„æˆªé¢å›å½’ï¼Œéƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªå› å­æ”¶ç›Šç‡ t çš„å€¼ã€‚å¯¹äºå€¼åºåˆ—ï¼Œé¦–å…ˆå–ç»å¯¹å€¼ï¼Œç„¶åè®¡ç®—|t|çš„å‡å€¼ï¼Œ|t|æ˜¯åˆ¤æ–­å› å­æ˜¯å¦ä¸ºæœ‰æ•ˆå› å­çš„é‡è¦æŒ‡æ ‡ã€‚ä¹‹æ‰€ä»¥è¦å–ç»å¯¹å€¼ï¼Œæ˜¯å› ä¸ºåªè¦ğ‘¡å€¼æ˜¾è‘—ä¸ç­‰äº 0 å³å¯ä»¥è®¤ä¸ºåœ¨å½“æœŸï¼Œå› å­å’Œæ”¶ç›Šç‡å­˜åœ¨æ˜æ˜¾çš„ç›¸å…³æ€§ã€‚ä½†æ˜¯è¿™ç§ç›¸å…³æ€§æœ‰çš„æ—¶å€™ä¸ºæ­£ï¼Œæœ‰çš„æ—¶å€™ä¸ºè´Ÿï¼Œå¦‚æœä¸å–ç»å¯¹å€¼ï¼Œåˆ™å¾ˆå¤šæ­£è´ŸæŠµæ¶ˆï¼Œä¼šä½ä¼°å› å­çš„æœ‰æ•ˆæ€§ï¼›
2. ğ‘¡å€¼ç»å¯¹å€¼åºåˆ—å¤§äº 2 çš„æ¯”ä¾‹ï¼šæ£€éªŒ|t| > 2 çš„æ¯”ä¾‹ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯|t|å¹³å‡å€¼çš„ç¨³å®šæ€§ï¼Œé¿å…å‡ºç°å°‘æ•°æ•°å€¼ç‰¹åˆ«å¤§çš„æ ·æœ¬å€¼æ‹‰é«˜å‡å€¼ï¼›
3. å› å­æ”¶ç›Šç‡ğ‘“ğ‘˜Ìƒğ‘¡åºåˆ—çš„ğ‘¡å€¼æ£€éªŒï¼šå¯¹äºæ¯ä¸€æœŸçš„æˆªé¢å›å½’ï¼Œéƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªå› å­æ”¶ç›Šç‡ğ‘“ğ‘˜Ìƒğ‘¡ï¼Œå¯¹äºğ‘“ğ‘˜Ìƒğ‘¡åºåˆ—åŒæ ·éœ€è¦è¿›è¡Œğ‘¡æ£€éªŒï¼Œä»¥è§‚å¯Ÿå› å­æ”¶ç›Šç‡åºåˆ—çš„æ–¹å‘ä¸€è‡´æ€§ã€‚
#+begin_src python
from scipy import stats
import numpy as np
#+end_src
*** IC æ³•
ä¿¡æ¯ç³»æ•°ï¼ˆInformation Coefficientï¼Œç®€ç§° ICï¼‰ï¼Œè¡¨ç¤ºæ‰€é€‰è‚¡ç¥¨çš„å› å­å€¼ä¸è‚¡ç¥¨ä¸‹æœŸæ”¶ç›Šç‡çš„æˆªé¢ç›¸å…³ç³»æ•°ï¼Œé€šè¿‡ IC å€¼å¯ä»¥åˆ¤æ–­å› å­å€¼å¯¹ä¸‹æœŸæ”¶ç›Šç‡çš„é¢„æµ‹èƒ½åŠ›ã€‚
é€šå¸¸ IC å¤§äº 3%æˆ–è€…å°äº-3%ï¼Œåˆ™è®¤ä¸ºå› å­æ¯”è¾ƒæœ‰æ•ˆ.å¸¸è§çš„ IC æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯ Normal ICï¼ˆç±»æ¯”çš®å°”æ£®ç›¸å…³ç³»æ•°æ¦‚å¿µï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ Rank ICï¼ˆç±»æ¯”æ–¯çš®å°”æ›¼ç›¸å…³ç³»æ•°ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º.
é‰´äº IC çš„é‡è¦æ€§ï¼Œåœ¨å¤šå› å­çš„å› å­åŠ æƒä¸­å¸¸é‡‡ç”¨å› å­æœ€è¿‘ N ä¸ªæœˆï¼ˆé»˜è®¤ä¸º 12ï¼‰çš„ IC å‡å€¼è¿›è¡ŒåŠ æƒï¼Œé€šå¸¸ç»“æœä¼šä¼˜äºç­‰æƒæ³•ã€‚
**** Normal IC
[[https://pic1.zhimg.com/80/v2-c643a7d4d75fccfb191d56d87f336304_720w.jpg]]
#+begin_src python
pccs = np.corrcoef(x, y)
#+end_src
**** Rank IC
[[https://pic2.zhimg.com/80/v2-d91f466cb41ea8f30dcf71e353a991bd_720w.png]]
1. IC å€¼åºåˆ—çš„å‡å€¼åŠç»å¯¹å€¼å‡å€¼ï¼šåˆ¤æ–­å› å­æœ‰æ•ˆæ€§ï¼›
2. IC å€¼åºåˆ—çš„æ ‡å‡†å·®ï¼šåˆ¤æ–­å› å­ç¨³å®šæ€§ï¼›
3. IC å€¼åºåˆ—å¤§äºé›¶ï¼ˆæˆ–å°äºé›¶ï¼‰çš„å æ¯”ï¼šåˆ¤æ–­å› å­æ•ˆæœçš„ä¸€è‡´æ€§ã€‚
#+begin_src python
pd.rank()
#+end_src
** å¤§ç±»å› å­åˆæˆ
*** çº¿æ€§ç›¸å…³æ€§æ£€éªŒ
#+begin_src python
# è®¡ç®—å› å­çš„ç›¸å…³ç³»æ•°çŸ©é˜µå‡½æ•°
def factor_corr(factors):
    factors = factors.set_index('code')
    factors_process = standardize_z(extreme_MAD(factors.fillna(0)))
    result = factors_process.fillna(0).corr()
    return result

# è·å–ç›¸å…³ç³»æ•°çŸ©é˜µ
factors_corr1 = factor_corr(factors1)
factors_corr2 = factor_corr(factors2)
factors_corr3 = factor_corr(factors3)
factors_corr4 = factor_corr(factors4)
factors_corr = (factors_corr1+factors_corr2+factors_corr3+factors_corr4).div(4)  # çŸ©é˜µå‡å€¼æ£€éªŒ

# ç›¸å…³ç³»æ•°æ£€éªŒ
abs(factors_corr).mean()
abs(factors_corr).median()
#+end_src

*corr hot map plot*
#+begin_src python
# ç”»å›¾äºŒ
fig = plt.figure()
plt.subplots(figsize=(8, 6.4))  # è®¾ç½®ç”»é¢å¤§å°
sns.heatmap(factors_corr, annot=True, vmax=1, vmin=-1, square=True, cmap="CMRmap_r",)
plt.show()
#+end_src
*** å› å­åˆæˆ
#+begin_src python
# ç­‰æƒæ³•
# è¦åˆæˆçš„å› å­åç§°
corrnames = []
collinear_factors = factors4.loc[:,corrnames]         # å…±çº¿çš„å› å­çŸ©é˜µ
composite_factor = collinear_factors.mul(1/len(corrnames)).sum(axis=1)
print(composite_factor)
#+end_src
** SVM ç®—æ³•ä»£ç 
#+begin_src python
 from sklearn.svm import SVC
 from sklearn.model_selection import GridSearchCV
 pipe_svc = Pipeline([('scl', StandardScaler()),
             ('clf', SVC(random_state=1))])
 param_range = [0.0001, 0.001, 0.01, 0.1, 1.0, 10.0, 100.0, 1000.0]
 param_grid = [{'clf__C': param_range,
                'clf__kernel': ['linear']},
                  {'clf__C': param_range,
                   'clf__gamma': param_range,
                  'clf__kernel': ['rbf']}]
 gs = GridSearchCV(estimator=pipe_svc,
                  param_grid=param_grid,
                  scoring='accuracy',
                  cv=10,
                  n_jobs=-1)
 gs = gs.fit(X_train, y_train)
 print(gs.best_score_)
 print(gs.best_params_)
 clf = gs.best_estimator_
 clf.fit(X_train, y_train)
 print ('Test accuracy: %.3f' % clf.score(X_test, y_test))
#+end_src
** å›æµ‹å­¦ä¹ 
* ç›¸ä¼¼å› å­
'TECH_REVS10','TECH_REVS20','TECH_REVS60','TECH_REVS120','TECH_DIFF','TECH_DEA'
